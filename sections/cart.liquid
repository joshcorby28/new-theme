{% comment %}
  This section is used in the cart template to render /cart page with an
  overview of the items in customer's cart.

  https://shopify.dev/docs/storefronts/themes/architecture/templates/cart
{% endcomment %}


{{ 'fract-cart.css' | asset_url | stylesheet_tag: preload: true }}

<div class="main-cart-title">
  <h1 class="cart-title">{{ 'cart.title' | t }}</h1>
  <span class="item-count">({{ cart.item_count }} item{% if cart.item_count != 1 %}s{% endif %})</span>
</div>

<form class="fract-cart" action="{{ routes.cart_url }}" method="post">
  <table class="main-cart-items">
    {% for item in cart.items %}
      <tr class="cart-item">
        <td class="cart-image-and-title">
          {% render 'image', image: item.image, url: item.url %}
          <div class="title-and-remove">
            <h3 class="cart-product-title">{{ item.product.title }}</h3>
      
            {% if item.product.has_only_default_variant == false or item.properties.size or item.selling_plan_allocation %}
              <div class="product-options">
                {% if item.product.has_only_default_variant == false %}
                  {% for option in item.options_with_values %}
                    <div class="product-option">
                      <dt>{{ option.name }}:</dt>
                      <dd> {{ option.value }}</dd>
                    </div>
                  {% endfor %}
                {% endif %}
              </div>
            {% endif %}

            {% if section.settings.show-stock-indicator %}
              {% assign inventory = item.variant.inventory_quantity %}
              {% assign in_stock = item.variant.available %}
              <div class="stock-indicator-wrapper">
                {% if in_stock %}
                  {% if inventory > 5 %}
                    <div class="stock-indicator in-stock">
                      <span class="circle"></span>
                      <span>In Stock</span>
                    </div>
                  {% else %}
                    <div class="stock-indicator low-stock">
                      <span class="circle"></span>
                      <span>Limited Stock</span>
                    </div>
                  {% endif %}
                {% else %}
                  <div class="stock-indicator out-of-stock">
                    <span class="circle"></span>
                    <span>Out of Stock</span>
                  </div>
                {% endif %}
              </div>
            {% endif %}

            {{ 'cart.remove' | t | link_to: item.url_to_remove }}
          </div>
        </td>

        <td>
          <span class="cart-item-price">
            {% if item.line_price == 0 and item.original_line_price > 0 %}
              {{ item.original_line_price | money }} <span style="color: #28a745; font-weight:bold;">(Free)</span>
            {% else %}
              {{ item.original_line_price | money }}
            {% endif %}
            {% if item.variant.compare_at_price > item.variant.price %}
              <span class="compare-at-price" style="text-decoration: line-through; color: #888; font-size:12px; font-weight:normal">
                {{ item.variant.compare_at_price | money }}
              </span>
            {% endif %}
          </span>
        </td>

        <td>
          <div class="quantity-selector">
            <button type="button" class="qty-btn minus">-</button>
            <input
              type="number"
              name="updates[]"
              min="1"
              value="{{ item.quantity }}"
              class="qty-input"
            />
            <button type="button" class="qty-btn plus">+</button>
          </div>
        </td>
      </tr>
    {% endfor %}
  </table>

  <div class="fract-footer-cart">
    {% assign pseudo_subtotal = 0 %}
    {% for item in cart.items %}
      {% assign pseudo_subtotal = pseudo_subtotal | plus: item.original_line_price %}
    {% endfor %}

    {% assign shipping_cost = 3.99 %}
    {% if pseudo_subtotal >= 8000 %}
      {% assign shipping_cost = 0 %}
    {% endif %}

    <div class="cart-summary">
      <div class="cart-summary-row">
        <span class="label">Subtotal</span>
        <span class="value" id="cart-subtotal">{{ pseudo_subtotal | money }}</span>
      </div>

      <div class="cart-summary-row">
        <span class="label">Shipping</span>
        <span class="value" id="cart-shipping">
          {% if shipping_cost == 0 %}Free{% else %}{{ shipping_cost | money }}{% endif %}
        </span>
      </div>

      {% if cart.total_discount > 0 %}
        <div class="cart-summary-row">
          <span class="label">Discounts</span>
          <span class="value" id="cart-discount">-{{ cart.total_discount | money }}</span>
        </div>
      {% else %}
        <div class="cart-summary-row">
          <span class="label">Discounts</span>
          <span class="value" id="cart-discount">Add at Checkout</span>
        </div>
      {% endif %}

      <div class="cart-summary-row cart-total">
        <span class="label"><strong>Total</strong></span>
        <span style="font-size:18px; font-weight:bold;" class="value" id="cart-total"><strong>{{ cart.total_price | money }}</strong></span>
      </div>
    </div>

    <button class="fract-primary button-skew" type="submit" name="checkout" value="{{ 'cart.checkout' | t }}">
      {{ 'cart.checkout' | t }}
    </button>
    <a style="width:100%" href="{{ routes.all_products_collection_url }}" class="fract-secondary button-skew continue-shopping">
      Continue Shopping
    </a>
  </div>
</form>

<script>
document.addEventListener("DOMContentLoaded", function() {
  const subtotalEl = document.querySelector('#cart-subtotal');
  const shippingEl = document.querySelector('#cart-shipping');
  const discountEl = document.querySelector('#cart-discount');
  const totalEl = document.querySelector('#cart-total');

  function formatMoney(cents) {
    return new Intl.NumberFormat('en-GB', {
      style: 'currency',
      currency: 'GBP'
    }).format(cents / 100);
  }

  function updateTotals(cart) {
    // Pseudo subtotal includes free items
    let pseudoSubtotal = 0;
    cart.items.forEach(item => {
      pseudoSubtotal += item.original_line_price;
    });

    let discount = cart.total_discount;
    let shipping = pseudoSubtotal >= 8000 ? 0 : 399; // in cents
    let total = cart.total_price; // Shopify total (after discounts)

    subtotalEl.textContent = formatMoney(pseudoSubtotal);
    shippingEl.textContent = shipping === 0 ? 'Free' : formatMoney(shipping);
    discountEl.textContent = discount > 0 ? '-' + formatMoney(discount) : 'Add at Checkout';
    totalEl.textContent = formatMoney(total);
  }

  // Fetch cart on load
  fetch('/cart.js')
    .then(res => res.json())
    .then(cart => updateTotals(cart));

  // Listen for Shopify cart updates
  document.addEventListener('cart:updated', () => {
    fetch('/cart.js')
      .then(res => res.json())
      .then(cart => updateTotals(cart));
  });

  // Fallback for quantity inputs changing
  document.body.addEventListener('change', (e) => {
    if (e.target.name && e.target.name.includes('updates')) {
      setTimeout(() => {
        fetch('/cart.js')
          .then(res => res.json())
          .then(cart => updateTotals(cart));
      }, 400);
    }
  });
});
</script>


{% schema %}
{
  "name": "t:general.cart",
  "settings": [
         {
        "type": "checkbox",
        "id": "show-stock-indicator",
        "default": true,
        "label": "Show Stock Indicator"
      },
  ]
}
{% endschema %}


<script>
  document.addEventListener('DOMContentLoaded', function () {
    document.querySelectorAll('.quantity-selector').forEach((container) => {
      const input = container.querySelector('.qty-input');
      const btnPlus = container.querySelector('.plus');
      const btnMinus = container.querySelector('.minus');

      const submitForm = () => {
        const form = container.closest('form');
        if (form) form.submit();
      };

      btnPlus.addEventListener('click', () => {
        input.value = Number(input.value) + 1;
        input.dispatchEvent(new Event('change'));
      });

      btnMinus.addEventListener('click', () => {
        const min = Number(input.min) || 1;
        if (Number(input.value) > min) {
          input.value = Number(input.value) - 1;
          input.dispatchEvent(new Event('change'));
        }
      });

      input.addEventListener('change', submitForm);
    });
  });
</script>

