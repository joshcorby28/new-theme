{% comment %}
  Cart Drawer Section for Shopify
{% endcomment %}

{{ 'fract-cart.css' | asset_url | stylesheet_tag: preload: true }}

<div id="cart-drawer" class="cart-drawer">
  <div class="cart-drawer-overlay"></div>
  <div class="cart-drawer-content">
    <div class="cart-drawer-header">
      <h2>Your Cart</h2>
      <span class="cart-item-count">({{ cart.item_count }} item{% if cart.item_count != 1 %}s{% endif %})</span>
      <button class="cart-drawer-close">&times;</button>
    </div>

    <div class="cart-drawer-items">
      {% for item in cart.items %}
        <div class="cart-drawer-item">
          <div class="cart-image">
            {% render 'image', image: item.image, url: item.url %}
          </div>
          <div class="cart-info">
            <h3>{{ item.product.title }}</h3>

            {% if item.product.has_only_default_variant == false or item.properties.size or item.selling_plan_allocation %}
              <div class="product-options">
                {% for option in item.options_with_values %}
                  <div class="product-option">
                    <span>{{ option.name }}:</span> {{ option.value }}
                  </div>
                {% endfor %}
              </div>
            {% endif %}

            <div class="cart-price">
              {% if item.line_price == 0 and item.original_line_price > 0 %}
                <span class="line-through">{{ item.original_line_price | money }}</span>
                <span class="free-label">Free</span>
              {% else %}
                {{ item.original_line_price | money }}
              {% endif %}
              {% if item.variant.compare_at_price > item.variant.price %}
                <span class="compare-at-price">{{ item.variant.compare_at_price | money }}</span>
              {% endif %}
            </div>

            <div class="quantity-selector">
              <button type="button" class="qty-btn minus">-</button>
              <input type="number" name="updates[]" min="1" value="{{ item.quantity }}" class="qty-input"/>
              <button type="button" class="qty-btn plus">+</button>
            </div>

            {{ 'cart.remove' | t | link_to: item.url_to_remove }}
          </div>
        </div>
      {% endfor %}
    </div>

    <div class="cart-drawer-footer">
      {% assign pseudo_subtotal = 0 %}
      {% for item in cart.items %}
        {% assign pseudo_subtotal = pseudo_subtotal | plus: item.original_line_price %}
      {% endfor %}

      {% assign shipping_cost = 3.99 %}
      {% if pseudo_subtotal >= 8000 %}
        {% assign shipping_cost = 0 %}
      {% endif %}

      <div class="cart-summary">
        <div class="cart-summary-row">
          <span>Subtotal</span>
          <span id="cart-subtotal">{{ pseudo_subtotal | money }}</span>
        </div>
        <div class="cart-summary-row">
          <span>Shipping</span>
          <span id="cart-shipping">{% if shipping_cost == 0 %}Free{% else %}{{ shipping_cost | money }}{% endif %}</span>
        </div>
        <div class="cart-summary-row">
          <span>Discounts</span>
          <span id="cart-discount">{% if cart.total_discount > 0 %}-{{ cart.total_discount | money }}{% else %}Add at Checkout{% endif %}</span>
        </div>
        <div class="cart-summary-row total">
          <span>Total</span>
          <span id="cart-total">{{ cart.total_price | money }}</span>
        </div>
      </div>

      <a href="/checkout" class="fract-primary button-skew checkout-btn">Checkout</a>
      <button class="fract-secondary button-skew continue-shopping-btn">Continue Shopping</button>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const drawer = document.getElementById('cart-drawer');
  const overlay = drawer.querySelector('.cart-drawer-overlay');
  const closeBtn = drawer.querySelector('.cart-drawer-close');
  const continueBtn = drawer.querySelector('.continue-shopping-btn');

  // Open / Close Drawer
  function openDrawer() {
    drawer.classList.add('open');
    overlay.style.visibility = 'visible';
    overlay.style.opacity = 1;
  }

  function closeDrawer() {
    drawer.classList.remove('open');
    overlay.style.opacity = 0;
    setTimeout(() => overlay.style.visibility = 'hidden', 300);
  }

  overlay.addEventListener('click', closeDrawer);
  closeBtn.addEventListener('click', closeDrawer);
  continueBtn.addEventListener('click', closeDrawer);

  // Cart Icon opens drawer
  const cartIcon = document.getElementById('cart-icon');
  if (cartIcon) {
    cartIcon.addEventListener('click', function(e) {
      e.preventDefault();
      fetchCart();
      openDrawer();
    });
  }

  // Quantity buttons inside drawer
  drawer.querySelectorAll('.quantity-selector').forEach(container => {
    const input = container.querySelector('.qty-input');
    const btnPlus = container.querySelector('.plus');
    const btnMinus = container.querySelector('.minus');

    btnPlus.addEventListener('click', () => {
      input.value = Number(input.value) + 1;
      input.dispatchEvent(new Event('change'));
    });

    btnMinus.addEventListener('click', () => {
      const min = Number(input.min) || 1;
      if (Number(input.value) > min) {
        input.value = Number(input.value) - 1;
        input.dispatchEvent(new Event('change'));
      }
    });

    input.addEventListener('change', () => {
      const lineIndex = Array.from(drawer.querySelectorAll('.qty-input')).indexOf(input);
      const formData = new FormData();
      formData.append(`updates[${lineIndex}]`, input.value);
      fetch('/cart/update.js', { method: 'POST', body: formData })
        .then(() => fetchCart());
    });
  });

  // Fetch cart and update drawer items/totals
  function fetchCart() {
    fetch('/cart.js')
      .then(res => res.json())
      .then(cart => {
        const subtotalEl = drawer.querySelector('#cart-subtotal');
        const shippingEl = drawer.querySelector('#cart-shipping');
        const discountEl = drawer.querySelector('#cart-discount');
        const totalEl = drawer.querySelector('#cart-total');

        // Pseudo subtotal includes free items
        let pseudoSubtotal = 0;
        cart.items.forEach(item => pseudoSubtotal += item.original_line_price);

        // Shipping: free if subtotal >= Â£80
        let shippingCents = pseudoSubtotal >= 8000 ? 0 : 399;

        subtotalEl.textContent = formatMoney(pseudoSubtotal);
        shippingEl.textContent = shippingCents === 0 ? 'Free' : formatMoney(shippingCents);
        discountEl.textContent = cart.total_discount > 0 ? '-' + formatMoney(cart.total_discount) : 'Add at Checkout';
        totalEl.textContent = formatMoney(cart.total_price + shippingCents);

        // Optional: update cart item count in header
        const cartCountEl = document.querySelector('#cart-icon sup');
        if(cartCountEl) cartCountEl.textContent = cart.item_count;
      });
  }

  function formatMoney(cents) {
    return new Intl.NumberFormat('en-GB', { style: 'currency', currency: 'GBP' }).format(cents / 100);
  }

  // Auto open drawer when an AJAX Add to Cart form is submitted
  document.querySelectorAll('form[action^="/cart/add"]').forEach(form => {
    form.addEventListener('submit', function(e) {
      e.preventDefault();
      const formData = new FormData(form);
      fetch('/cart/add.js', { method: 'POST', body: formData })
        .then(res => res.json())
        .then(item => {
          // Trigger custom cart updated event
          const event = new Event('cart:updated');
          document.dispatchEvent(event);
        });
    });
  });

  // Open drawer automatically when cart is updated
  document.addEventListener('cart:updated', () => {
    fetchCart();
    openDrawer();
  });

  // Initial load: update cart
  fetchCart();
});
</script>


<style>
/* Minimal drawer styling */
.cart-drawer { position: fixed; top:0; right:0; width:360px; height:100%; background:#fff; box-shadow:-2px 0 12px rgba(0,0,0,0.2); transform:translateX(100%); transition: transform 0.3s ease; z-index:9999; }
.cart-drawer.open { transform:translateX(0); }
.cart-drawer-overlay { position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.4); opacity:0; visibility:hidden; transition:opacity 0.3s; z-index:9998; }
.cart-drawer.open ~ .cart-drawer-overlay { opacity:1; visibility:visible; }
.cart-drawer-content { display:flex; flex-direction:column; height:100%; }
.cart-drawer-header { display:flex; justify-content:space-between; align-items:center; padding:1rem; border-bottom:1px solid #eee; }
.cart-drawer-items { flex:1; overflow-y:auto; padding:1rem; }
.cart-drawer-footer { padding:1rem; border-top:1px solid #eee; display:flex; flex-direction:column; gap:0.5rem; }
.cart-drawer-item { display:flex; margin-bottom:1rem; gap:1rem; }
.cart-image img { width:60px; height:60px; object-fit:cover; }
.cart-info { flex:1; }
.quantity-selector { display:flex; align-items:center; gap:0.25rem; }
.line-through { text-decoration: line-through; opacity:0.5; margin-right:0.25rem; }
.free-label { font-weight:bold; color:#000; }
.checkout-btn, .continue-shopping-btn { width:100%; text-align:center; }
</style>
