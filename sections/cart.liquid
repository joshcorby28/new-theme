{% comment %}
  This section is used in the cart template to render /cart page with an
  overview of the items in customer's cart.

  https://shopify.dev/docs/storefronts/themes/architecture/templates/cart
{% endcomment %}


{{ 'fract-cart.css' | asset_url | stylesheet_tag: preload: true }}

<div class="main-cart-title">
<h1 class="cart-title">{{ 'cart.title' | t }}</h1> <span class="item-count">({{ cart.item_count }} item{% if cart.item_count != 1 %}s{% endif %})</span>
</div>

<form class="fract-cart" action="{{ routes.cart_url }}" method="post">
  <table class="main-cart-items">
    {% for item in cart.items %}
     <tr class="cart-item">
        <td class="cart-image-and-title">
          {% render 'image', image: item.image, url: item.url %}
          <div class="title-and-remove">
            <h3 class="cart-product-title">{{ item.product.title }}</h3>
      
            {% if item.product.has_only_default_variant == false or item.properties.size or item.selling_plan_allocation %}
              <div class="product-options">
                {% if item.product.has_only_default_variant == false %}
                  {% for option in item.options_with_values %}
                    <div class="product-option">
                      <dt>{{ option.name }}:</dt>
                      <dd> {{ option.value }}</dd>
                    </div>
                  {% endfor %}
                {% endif %}
              </div>
            {% endif %}
      
            {{ 'cart.remove' | t | link_to: item.url_to_remove }}
          </div>
        </td>
      <td>
      <span class="cart-item-price">
        {{ item.original_line_price | money }}
        {% if item.variant.compare_at_price > item.variant.price %}
          <span class="compare-at-price" style="text-decoration: line-through; color: #888; font-size:12px; font-weight:normal">
            {{ item.variant.compare_at_price | money }}
          </span>
        {% endif %}
      </span>
      </td>
        <td>
          <div class="quantity-selector">
            <button type="button" class="qty-btn minus">-</button>
            <input
              type="number"
              name="updates[]"
              min="1"
              value="{{ item.quantity }}"
              class="qty-input"
            />
            <button type="button" class="qty-btn plus">+</button>
          </div>
        </td>
      </tr>
    {% endfor %}
  </table>
  <div class="fract-footer-cart">
    <div class="cart-summary" >
  <div class="cart-summary-row">
    <span class="label">Subtotal</span>
    <span class="value">{{ cart.total_price | money }}</span>
  </div>
  <div class="cart-summary-row">
    <span class="label">Shipping</span>
    <span class="value">Calculated at checkout</span>
  </div>
</div>

  <button class="fract-primary button-skew" type="submit" name="checkout" value="{{ 'cart.checkout' | t }}">{{ 'cart.checkout' | t }}</button>
    <a href="{{ routes.all_products_collection_url }}" class="fract-secondary button-skew continue-shopping">
        Continue Shopping
    </a>
  </div>
</form>

{% schema %}
{
  "name": "t:general.cart",
  "settings": []
}
{% endschema %}

<script>
document.addEventListener('DOMContentLoaded', function () {
  const fractCart = document.querySelector('.fract-cart');
  if (!fractCart) return;

  fractCart.addEventListener('click', (e) => {
    if (e.target.matches('.qty-btn.plus') || e.target.matches('.qty-btn.minus')) {
      const container = e.target.closest('.quantity-selector');
      if (!container) return;

      const input = container.querySelector('.qty-input');
      if (!input) return;

      const min = Number(input.min) || 1;
      let currentVal = Number(input.value);

      if (e.target.classList.contains('plus')) {
        input.value = currentVal + 1;
      } else if (e.target.classList.contains('minus')) {
        if (currentVal > min) input.value = currentVal - 1;
      }

      // Trigger change event to update cart
      input.dispatchEvent(new Event('change'));
    }
  });

  fractCart.addEventListener('change', (e) => {
    if (e.target.matches('.qty-input')) {
      // Submit form via AJAX on qty input change
      const input = e.target;
      const container = input.closest('.quantity-selector');
      if (!container) return;

      const form = container.closest('form');
      if (!form) return;

      const formData = new FormData(form);

      fetch(form.action, {
        method: 'POST',
        body: formData,
        headers: {
          'Accept': 'text/html',
        },
      })
        .then((res) => res.text())
        .then((html) => {
          const parser = new DOMParser();
          const doc = parser.parseFromString(html, 'text/html');

          const newCart = doc.querySelector('.fract-cart');
          const currentCart = document.querySelector('.fract-cart');
          if (newCart && currentCart) {
            currentCart.innerHTML = newCart.innerHTML;
          }
        })
        .catch((err) => {
          console.error('Cart update failed', err);
        });
    }
  });
});

</script>