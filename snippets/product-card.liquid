{{ 'product-card.css' | asset_url | stylesheet_tag: preload: true }}

  {% if product.tags contains 'comingsoon'  %}
                <style>
                  .coming-soon:hover .hover-image {
  opacity: 0 !important;
}

.coming-soon:hover  .primary-image {
  opacity: 1 !important;
}

</style>
{% endif %}

<div class="product-card">
  <a href="{{ product.url }}" class="product-card__link">
<div class="{% if product.tags contains 'comingsoon'  %}coming-soon{%endif%} product-card__image-wrapper">
  {% assign first_image = product.featured_image %}
  {% assign second_image = product.images[1] %}

  <img
    src="{{ first_image | image_url: width: 600 }}"
    alt="{{ first_image.alt | escape }}"
    class="product-card__image primary-image"
  >
    

  {% if second_image %}
    <img
      src="{{ second_image | image_url: width: 600 }}"
      alt="{{ second_image.alt | escape }}"
      class="product-card__image hover-image"
      loading="lazy"
    >
  {% endif %}
{% assign prReviewCount = product.metafields.doran.prReviewCount | default: 0 %}
{% if prReviewCount > 0 %}
<script type="text/javascript">
  window.$prDoranInit = window.$prDoranInit || {};
  window.$prDoranInit.ratingWidgetReview = window.$prDoranInit.ratingWidgetReview || {};
  
  var productReview = {
    reviewsCount: {{ product.metafields.doran.prReviewCount | default: 0 }},
    averageRating: {{ product.metafields.doran.prAvgRating | default: 0 }},
    stars1: {{ product.metafields.doran.prStar1 | default: 0 }},
    stars2: {{ product.metafields.doran.prStar2 | default: 0 }},
    stars3: {{ product.metafields.doran.prStar3 | default: 0 }},
    stars4: {{ product.metafields.doran.prStar4 | default: 0 }},
    stars5: {{ product.metafields.doran.prStar5 | default: 0 }}
  };

  if (typeof window.$prDoranInit.ratingWidgetReview['{{ product.id }}'] === 'undefined') {
    window.$prDoranInit.ratingWidgetReview['{{ product.id }}'] = productReview;
  } else {
    var existingProductReview = window.$prDoranInit.ratingWidgetReview['{{ product.id }}'];
    window.$prDoranInit.ratingWidgetReview['{{ product.id }}'] = Object.assign(existingProductReview, productReview);
  }

  // Inject styles inside iframe
  function styleRatingWidget() {
    var iframe = document.querySelector('#badge-{{ product.id }} iframe');
    if (iframe && iframe.contentDocument) {
      var style = document.createElement('style');
      style.innerHTML = `
        body { 
          color: #1b1b1b; 
          font-size: 0.85rem; 
        }
        .rating-icon-wrapper, svg {
          width: 14px !important;
          height: 14px !important;
        }
        .rating-icon-wrapper path {
          fill: #1b1b1b !important;
        }
      `;
      iframe.contentDocument.head.appendChild(style);
    } else {
      setTimeout(styleRatingWidget, 200);
    }
  }

  styleRatingWidget();
</script>

<!-- Badge wrapper -->
<div style="position: absolute; top: 10px; right: 10px; background: rgba(255,255,255,0.9); border-radius: 8px; padding: 4px 6px; box-shadow: 0 2px 6px rgba(0,0,0,0.2); z-index: 10;" id="badge-{{ product.id }}">
  <div
    data-dr="rating-widget"
    data-class-name="collection-page"
    data-hide-detail="true"
    data-product-id="{{ product.id }}"
    data-reviews-count="{{ product.metafields.doran.prReviewCount | default: 0 }}"
    data-average-rating="{{ product.metafields.doran.prAvgRating | default: 0 }}"
    data-star1="{{ product.metafields.doran.prStar1 | default: 0 }}"
    data-star2="{{ product.metafields.doran.prStar2 | default: 0 }}"
    data-star3="{{ product.metafields.doran.prStar3 | default: 0 }}"
    data-star4="{{ product.metafields.doran.prStar4 | default: 0 }}"
    data-star5="{{ product.metafields.doran.prStar5 | default: 0 }}"
    data-show-only-reviews-count="true"
  ></div>
</div>
{% endif %}

  {% if product.tags contains 'comingsoon' %}
    <div class="product-card__overlay">
      Coming Soon
    </div>
  {% endif %}
</div>

<style>
.product-card__image-wrapper {
  position: relative;
}

.product-card__image {
  display: block;
  width: 100%;
}

.product-card__overlay {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0,0,0,0.5);
  color: white;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: bold;
  font-size: 1.2rem;
  text-transform: uppercase;
  z-index: 10; /* ensures overlay is on top of hover image */
  pointer-events: none; /* so hover still works */
}

.product-card .price--sale {
  font-weight: bold;
  margin-right: 6px;
  color:#d55653;
  font-size:14px;
}

.price--compare {
  text-decoration: line-through;
  opacity: 0.7;
}

.price--regular {
  font-weight: 500;
}


</style>
<div class="drop-badge">

  {% if product.compare_at_price > product.price %}
      {% assign savings = product.compare_at_price | minus: product.price %}
      {% assign percent_off = savings | times: 100 | divided_by: product.compare_at_price %}
      {{ percent_off | round }}% OFF
  {% elsif product.tags contains 'blanks' %}
      Heavyweight Blank
  {% elsif product.tags contains 'comingsoon' %}
      Coming Soon
  {% else %}
      Discover The Unknown
  {% endif %}

</div>


    <div class="product-card__info">
      <h3 class="product-card__title">{{ product.title }}</h3>
      <p class="product-card__price">

        {% if product.compare_at_price > product.price %}
          <span class="price--sale">{{ product.price | money }}</span>
          <span class="price--compare">{{ product.compare_at_price | money }}</span>
        {% else %}
          <span class="price--regular">{{ product.price | money }}</span>
        {% endif %}

      </p>


 {% assign total_inventory = 0 %}

  {% for variant in product.variants %}
    {% assign total_inventory = total_inventory | plus: variant.inventory_quantity %}
  {% endfor %}

  {% assign in_stock = product.available %}

  <div class="stock-indicator-wrapper">
    {% if in_stock %}
      {% if total_inventory < 11 %}
        <div class="stock-indicator low-stock">
          <span class="circle"></span>
          <span>Limited Stock</span>
        </div>
      {% else %}
        <div class="stock-indicator in-stock">
          <span class="circle"></span>
          <span>In Stock</span>
        </div>
      {% endif %}
    {% else %}
      <div class="stock-indicator out-of-stock">
        <span class="circle"></span>
        <span>Out of Stock</span>
      </div>
    {% endif %}
  </div>

    </div>
  </a>
</div>
